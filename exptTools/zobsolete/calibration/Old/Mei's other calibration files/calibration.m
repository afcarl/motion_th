function index = calibration(whichPatch, whichGun,...                   stepSize, numRepeats, bgDAC, deviceNum)% index = calibration(whichPatch, whichGun, stepSize, %                     numRepeats, bgDAC)%% Displays color patches over neutral background, for% calibration measurements, mainly gamma curve measurements.%%  whichPatch --  %     1 = left patch; 2 = right patch (of the standard size)%       if whichPatch is any other single integer, patch is set%       to fill the whole screen;%     3 = dailyTest patch, sides=190, centered;%     if whichPatch is a 2-number matrix, the patch is%       centered at the location specified by the 2 numbers,%       and patch is the standard size;%     if whichPatch is a 4-number matrix, it is used as%       the patch rectangle%  whichGun   --  1 = red; 2 = green; 3 = blue;%     if a matrix with 3 columns is given, then it is taken as%     the colors of the patch.%  stepSize -- DAC values from 0-255, measure all 255 levels or%              less? stepSize determines measurement resolution.%              if stepSize is a 3 vector, use it as%              [start end stepSize];%  bgDAC    -- DAC values of backgroundif (nargin==0) whichPatch = 1;endif (nargin<2) whichGun = [1 1 1] * 255;endif (nargin<3) stepSize = [0 255 85];endif (nargin<4) numRepeats = 1;endif (nargin<5) bgDAC = [188 192 191];   % = monitor intensity [.5 .5 .5]endif (nargin<6) deviceNum = 0;   % 0 is the main display deviceend% initialize variablesbgColor = 1;patchColor = 2;myClut = zeros(255,3);myClut(bgColor,:) = bgDAC;myClut(patchColor,:) = [0 0 0];patchH = 48;patchW = 48;xDist = 48;         % Distance of patch from horizontal centeryDist = 24;         % Distance of patch from vertical center% Set up screenHideCursor;bgRect = screen('OpenScreen', bgColor-1, deviceNum);bgH = bgRect(3) - bgRect(1);bgW = bgRect(4) - bgRect(2);xCenter = round(bgW/2);yCenter = round(bgH/2);if (length(whichPatch)==4) patchRect = whichPatch;endif (length(whichPatch)==2) xCenter = whichPatch(1); yCenter = whichPatch(2); patchRect = [ yCenter-patchH/2  xCenter-patchW/2 ...               yCenter+patchH/2  xCenter+patchW/2 ];endif (length(whichPatch)==1)  if (whichPatch == 1)    patchRect = [yCenter-yDist-patchH  xCenter-xDist-patchW ...                 yCenter-yDist         xCenter-xDist ];  elseif (whichPatch == 2)    patchRect = [yCenter+yDist         xCenter+xDist ...                 yCenter+yDist+patchH  xCenter+xDist+patchW];  elseif (whichPatch == 3)    patchRect = [yCenter-95 xCenter-95 yCenter+95 xCenter+95];  else    patchRect = bgRect;  endendscreen('DrawRect', patchColor-1, patchRect)index = [];if (size(whichGun,2)==3) for step=1:size(whichGun,1)   myClut(bgColor,:) = bgDAC;   myClut(patchColor,:) = round(whichGun(step,:));   screen('SetClut', myClut);   theKey = GetKey;    % turn the whole screen into patchColor   myClut(bgColor,:) = myClut(patchColor,:);   screen('SetClut', myClut);   theKey = GetKey; endelse start = 0; finish = 255; if (length(stepSize)==3)   start = stepSize(1);   finish = stepSize(2);   stepSize = stepSize(3); end for step = start:stepSize:(finish+stepSize-1)  if (step>finish) step=finish;  end  if (length(whichGun)==1) increment = step;  else increment = step * ones(whichGun);  end for repeat = 1:numRepeats  index = [index; step];  myClut(bgColor,:) = bgDAC;  myClut(patchColor,whichGun) = increment;  screen('SetClut', myClut);  theKey = GetKey;  % turn the whole screen into patchColor  myClut(bgColor,:) = myClut(patchColor,:);  screen('SetClut', myClut);  theKey = GetKey;  if (theKey=='0') break;  end end endendscreen('CloseScreen');ShowCursor;