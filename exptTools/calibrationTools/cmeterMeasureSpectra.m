function [gunSpects, wavelengths, xyz] = cmeterMeasureSspectra(tsize, gunColors, monitor, ...														  synchFreq, hitKey)%% [gunSpects, wavelengths, xyz] = cmeterNECspectra(tsize, gunColors, monitor, synchFreq, hitKey)%% AUTHOR:  		Heidi Baseler% DATE:			02.12.98% HISTORY:		Adapted for NEC LCD2000 from "cmeterSpectraCalib.m"%				written by Xuemei Zhang on Turquoise, 08.98%% PURPOSE: 		Measure spectral power distribution of display guns using cmeter%% INPUTS:% tsize:		Size of target square, as [ysize xsize].%          		If tsize has 4 elements, treat as rectangle:%          		[ysize xsize ycenter xcenter].%         	 	If tsize has 1 element, target is a square.% gunColors:	Which guns to measure. Should be in the range [0 1].%              	For example, to measure red gun use [1 0 0].% monitor:		Use 0 for console, 1 for second monitor (check monitor numbers)% synchFreq:	Refresh rate of monitor (can be floating point number)% hitKey:		optional.  A value of 1 means that the user will have%				to hit a key before calibration begins.  A value of 0 means that%				the calibration will begin directly.  Default=1.%%			09.09.98  Converted from cmeterNECSpectra()%			9/12/00	  Ress Cleaned up text prompts, screen open problem.%if (length(tsize)==1)  tsize = [tsize tsize];endif (nargin<5)	hitKey = 1;end% Open screen and find center[screenPtr, screenRect] = screen(monitor, 'OpenWindow', 0, [], 8);HideCursor;if (length(tsize)==4)  xc = tsize(4);  yc = tsize(3);else  xc = (screenRect(RectRight) - screenRect(RectLeft))/2;  yc = (screenRect(RectBottom) - screenRect(RectTop))/2;endxc0 = xc - 150;yc0 = yc + 150;targetClut = 1;bgClut = 0;cmapMax = 1023;textClut = 255;nCmapBits = 10;targetMap = gray(256)*cmapMax;targetMap(bgClut+1,:) = [0 0 0];		   targetMap(targetClut+1,:) = [1 1 1] * cmapMax;		   targetMap(textClut+1,:) = [1 1 1] * cmapMax;		  screen(screenPtr, 'SetClut', targetMap);		   % Display a small target so that we can aim and focus camera:if (hitKey==1)	targetRect([RectTop RectLeft RectBottom RectRight])= ...    	       [yc xc yc xc]+[-1 -1 1 1]*50;	screen(screenPtr, 'FillRect', targetClut, targetRect);	screen(screenPtr, 'TextFont', 20);	screen(screenPtr, 'TextSize', 16);	screen(screenPtr, 'TextStyle', 1);	[xc1, yc1] = screen(screenPtr, 'DrawText', 'Aim and focus camera, then press any key', ...                        xc0, yc0, textClut);	textRect = [xc0 yc0-20 xc1 yc1+10];	GetChar;	screen(screenPtr, 'FillRect', bgClut, textRect);	[xc1, yc1] = screen(screenPtr, 'DrawText', 'OK.  You have 10 seconds to leave the room', ...    	                           xc0, yc0, textClut);	textRect = [xc0 yc0-20 xc1 yc1+10];	pause(10); % Give you enough time to leave the room and shut the doorend% Erase text, draw calibration targetscreen(screenPtr, 'FillRect', bgClut, textRect);targetRect([RectTop RectLeft RectBottom RectRight])= ...           [yc xc yc xc]+[-tsize(1) -tsize(2) tsize(1) tsize(2)]/2;screen(screenPtr, 'FillRect', targetClut, targetRect);screen(screenPtr, 'SetClut', targetMap);		   % Prepare cameras = cmeter('Init');                 %% initialize cameracmeter('SetParams', 0, 0, 1);       %% set synch,integration time, avgcnt%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Spectral measurementavgcnt = 5;gunSpects = zeros(101, size(gunColors,1));xyz = zeros(3, size(gunColors,1));for gun = 1:size(gunColors,1)  targetMap(targetClut+1,:) = gunColors(gun,:) * cmapMax;% HAB 02.13.98  - Must explicitly set Gamma and SetClut to 10 bits!   screen(screenPtr, 'Gamma', targetMap, nCmapBits);		     screen(screenPtr, 'SetClut', gray(256)*255);	  integrationTime = cmeterGetTime(synchFreq);  cmeter('SetParams', 0, integrationTime, avgcnt);  s = cmeter('Measure', integrationTime*(avgcnt+2));    spect = cmeter('Spectrum');         %% get spectrum  gunSpects(:,gun) = spect(:,2);  xyz(:, gun) = cmeter('XYZ');endwavelengths = spect(:,1);ShowCursor;screen(screenPtr, 'Close');